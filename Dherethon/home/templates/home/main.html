<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í™ˆ</title>
  <style>
    .challenge-card, .popular-post, .recommended-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .progress-bar {
      height: 12px;
      background: #e0e0e0;
      border-radius: 6px;
      margin: 5px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #5A3FFF;
    }
    .button {
      padding: 6px 12px;
      background: #5A3FFF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
    }
  </style>
</head>
<body>
            <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
        <div style="width:200px; padding:10px;">
            <p><strong>{{ request.user.nickname }}</strong></p>
            <ul>
                <p><a href="{% url 'home:main' %}">í™ˆ</a></p>
                <p><a href="{% url 'challenges:my_challenges' %}">ë‚˜ì˜ ë„ì „</a></p>
                <p><a href="{% url 'community:post_list' %}">ì»¤ë®¤ë‹ˆí‹°</a></p>
                <p><a href="{% url 'home:badge_list' %}">ë±ƒì§€</a></p>
            </ul>
            <p><a href="{% url 'api:logout' %}">Log out</a></p>
        </div>

<h2>ğŸ‘‹ {{ request.user.nickname }} ë‹˜ì˜ Challenges</h2>

<div id="my-challenges-box">
{% for challenge in my_challenges %}
  <div class="challenge-card">
    <h3>{{ challenge.title }}</h3>
    <div class="progress-bar">
      <div class="progress-fill" style="width: {{ challenge.progress }}%;"></div>
    </div>
    <p>ì§„í–‰ë¥ : {{ challenge.progress }}%</p>
    {% if challenge.next_goal %}
      <p><strong>ë‹¤ìŒ ì„¸ë¶€ ëª©í‘œ:</strong> {{ challenge.next_goal.content }}</p>
      <a href="{% url 'challenges:create_goal' challenge.id %}" class="button">ì¸ì¦í•˜ëŸ¬ ê°€ê¸° â†’</a>
    {% endif %}
  </div>
{% empty %}
  <p>ì§„í–‰ ì¤‘ì¸ ë„ì „ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endfor %}
</div>

<hr>

<h2>ğŸ”¥ ì¸ê¸° POST</h2>
{% for post in popular_posts %}
<div class="popular-post">
  <p>{{ post.content|truncatechars:50 }}</p>
  <p>â¤ï¸ ì¢‹ì•„ìš” {{ post.like_count }}</p>
  <a href="{% url 'community:post_detail' post.id %}">ìì„¸íˆ ë³´ê¸°</a>
</div>
{% empty %}
<p>ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endfor %}

<hr>

<div class="recommended-box">
 <h3>ğŸ’¡ ë‹¤ë¥¸ ìœ ì €ì˜ ë„ì „ ì¶”ì²œ</h3>

{% if recommended_challenges %}
    {% for item in recommended_challenges %}
        <div class="recommended-challenge-box">
            <h4>{{ item.challenge.user.nickname }}ë‹˜ì˜ Challenge</h4>
            <p><strong>{{ item.challenge.title }}</strong></p>
            <ul>
                {% for goal in item.goals %}
                    <li>{{ goal.content }}</li>
                {% endfor %}
            </ul>

            <!-- âœ… ì—¬ê¸°ì— ì´ ì½”ë“œ ì¶”ê°€ -->
            <form method="post" action="{% url 'challenges:copy_challenge' item.challenge.id %}">
            {% csrf_token %}
            <button type="submit" class="button">ë„ì „ ì¶”ê°€í•˜ê¸° â•</button>
            </form>
        </div>
    {% endfor %}
{% else %}
    <p>ì¶”ì²œí•  ë„ì „ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}
</div>


<script>
function refreshRecommendation() {
    fetch("{% url 'home:refresh_recommendation' %}")
        .then(res => res.json())
        .then(data => {
            document.getElementById("recommendation-card").innerHTML = data.html;
        });
}
</script>
</div>
<script>
function copyChallenge(challengeId) {
    fetch(`/copy-challenge/${challengeId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("ë„ì „ì´ ë‚´ ë„ì „ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
            // ìƒˆ ë„ì „ HTMLì„ my_challenges ì˜ì—­ì— ì‚½ì…
            document.getElementById("my-challenges-box").insertAdjacentHTML("beforeend", data.new_challenge_html);
        } else {
            alert("ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    });
}
</script>

</body>
</html>
