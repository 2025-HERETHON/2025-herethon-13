<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¸ì¦ ê¸€ ê²Œì‹œí•˜ê¸°</title>
  <style>
    .card {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px 0;
      cursor: pointer;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    .card.selected {
      border: 2px solid #5A3FFF;
      background-color: #eae6ff;
    }
    img.preview-img {
      max-width: 300px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h2>ğŸ“ ì¸ì¦ ê¸€ ê²Œì‹œí•˜ê¸°</h2>

<form method="post" enctype="multipart/form-data" action="{% url 'community:create_post' %}">
  {% csrf_token %}

  <label for="challenge-select"><strong>ë„ì „ ì„ íƒ:</strong></label><br>
  <select id="challenge-select" name="challenge">
    <option value="">ë„ì „ì„ ì„ íƒí•˜ì„¸ìš”</option>
    {% for challenge in challenges %}
      <option value="{{ challenge.id }}">{{ challenge.title }}</option>
    {% endfor %}
  </select><br><br>

  <!-- ì¸ì¦ ê¸°ë¡ ëª©ë¡ -->
  <div id="progress-list" style="display:none;">
    <h4>ì¸ì¦ ê¸°ë¡ ëª©ë¡</h4>
    <div id="progress-cards"></div>
  </div>

  <!-- ì„ íƒëœ goal_progress id -->
  <input type="hidden" name="goal_progress" id="selected-progress-id">

  <!-- ì„ íƒí•œ ì¸ì¦ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° -->
  <div id="preview-container" style="display:none; margin-top:20px;">
    <h4>ì„ íƒí•œ ì¸ì¦ ë¯¸ë¦¬ë³´ê¸°</h4>
    <p><strong>ì¸ì¦ ë‚´ìš©:</strong></p>
    <p id="preview-content" style="white-space: pre-line;"></p>
    <div>
      <p><strong>ì´ë¯¸ì§€:</strong></p>
      <img id="preview-image" class="preview-img" src="" alt="ì¸ì¦ ì´ë¯¸ì§€" style="display:none;">
    </div>
  </div>

  <button type="submit">ê²Œì‹œí•˜ê¸°</button>
</form>

<script>
  const challengeSelect = document.getElementById('challenge-select');
  const cardContainer = document.getElementById('progress-cards');
  const progressList = document.getElementById('progress-list');
  const previewContainer = document.getElementById('preview-container');
  const previewContent = document.getElementById('preview-content');
  const previewImage = document.getElementById('preview-image');
  const hiddenInput = document.getElementById('selected-progress-id');

  challengeSelect.addEventListener('change', function () {
    const challengeId = this.value;
    cardContainer.innerHTML = '';
    progressList.style.display = 'none';
    previewContainer.style.display = 'none';
    hiddenInput.value = '';

    if (!challengeId) return;

    fetch(`/community/load_goal_progresses/?challenge_id=${challengeId}`)
      .then(res => res.json())
      .then(data => {
        if (data.length === 0) {
          alert("ê²Œì‹œí•  ìˆ˜ ìˆëŠ” ì¸ì¦ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        data.forEach(progress => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <strong>${progress.goal_title}</strong><br>
            <small>${progress.date}</small><br>
            <p>${progress.content}</p>
            ${progress.image_url ? `<img src="${progress.image_url}" class="preview-img">` : ''}
          `;

          // í´ë¦­í•˜ë©´ ì„ íƒë˜ë„ë¡
          card.addEventListener('click', () => {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            hiddenInput.value = progress.id;

            previewContent.textContent = progress.content;
            if (progress.image_url) {
              previewImage.src = progress.image_url;
              previewImage.style.display = 'block';
            } else {
              previewImage.style.display = 'none';
            }
            previewContainer.style.display = 'block';
          });

          cardContainer.appendChild(card);
        });

        progressList.style.display = 'block';
      })
      .catch(() => alert("ì¸ì¦ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."));
  });
</script>

</body>
</html>
